version: "2"
volumes:
  podman-sock:
  redis:
services:
  server:
    image: "aparcar/asu:latest"
    build:
      context: ./
      dockerfile: Containerfile
    environment:
      - REDIS_HOST=redis
    volumes:
      - "./asu-service/public/:/app/public/"
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      - redis

  worker:
    image: "aparcar/asu:latest"
    build:
      context: ./
      dockerfile: Containerfile
    command: rqworker --url "redis://redis"
    environment:
      - CONTAINER_HOST=unix:///tmp/socket/podman.sock
    volumes:
      - ./asu-service/public/:/app/public/
      - podman-sock:/tmp/socket/
    depends_on:
      - redis
      - podman

  worker2:
    image: "aparcar/asu:latest"
    build:
      context: ./
      dockerfile: Containerfile
    command: rqworker --url "redis://redis"
    environment:
      - CONTAINER_HOST=unix:///tmp/socket/podman.sock
    volumes:
      - ./asu-service/public/:/app/public/
      - podman-sock:/tmp/socket/
    depends_on:
      - redis
      - podman

  podman:
    image: quay.io/podman/stable
    user: podman
    volumes:
      - podman-sock:/tmp/socket/
    command: sh -c "mkdir -p /tmp/socket && podman system service --time=0 unix:///tmp/socket/podman.sock"

  redis:
    image: "redis:alpine"
    volumes:
      - redis:/data/

# Podman may not allow ports 1024, consider using an external web server
# webserver:
#   image: caddy
#   volumes:
#     - "./misc/Caddyfile:/etc/caddy/Caddyfile"
#     - "./asu-service:/site/"
#   ports:
#     - "8000:8081"
#   depends_on:
#     - server
